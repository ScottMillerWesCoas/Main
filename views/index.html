<!DOCTYPE html>
  <head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <!-- BOOTSTRAP FOR RESPONSIVE DIVS -->
  <!-- Latest compiled and minified CSS -->
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
-->

<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
 -->
<!-- Latest compiled and minified JavaScript -->
<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>  -->
<!-- End of Bootstrap -->

    <link rel="stylesheet" type="text/css" href="./public/styles.css">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="./lib/three.min.js"></script>
    <script type="text/javascript" src="./lib/dat.gui.min.js"></script>
    <script type="text/javascript" src="./lib/OBJLoader.js"></script>
    <script type="text/javascript" src="./lib/heartcode-canvasloader.js"></script>
    <script type="text/javascript" src="./lib/physi.js"></script>
    <script type="text/javascript" src="./lib/tracking-min.js"></script>
    <script type="text/javascript" src="./lib/cv.js"></script>
    <script type="text/javascript" src="./lib/handTracking.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet">

    <title>Copernicus</title>

  </head>

  <body>
    <div id="test1">
      <img id="whiteCircle" src="assets/circleCanvas.jpg">
      <canvas id="testcanvas" style="width:160px; height:120px"></canvas>
      <button id="start-scan">Start Webcam</button>
    </div>
    <div id="take-snapshot">
      <img  id="hand-image" src="assets/transparentCircle.png">
    </div>
    <div class = "loading-container">
      <div id="container">

        <div id='bg'>
          <div id="infoPanel">
            <video id="myVideo" width="160px" height:"120px" preload autoplay loop muted></video>
            <canvas id="canvas" style="width:160px; height:120px"></canvas>
           <!-- CANVAS FOR TAKING PICTURE -->
            <canvas id="test" style="width:160px; height:120px"></canvas>
            <div id="heightArea">Height: </div>
            <div id="distArea">Distance: </div>
          </div>
          <div id="signalingArea"></div>
          <button id='throwBall'>Click anywhere to throw!</button>
          <div id='pointsDiv'>Player 1 Points: <span id='p1Points'>0</span><br>Player 2 Points: <span id='p2Points'>0</span></div>
        </div>

    </div>

    <script type="text/javascript" src="/public/dataChannel.js"></script>
    <script type="text/javascript" src="/scene/loaderAndLoadingScreen.js"></script>
    <script type="text/javascript" src="/scene/ball.js"></script>
    <script type="text/javascript" src="/public/tracker.js"></script>
    <script type="text/javascript" src="/scene/target.js"></script>
    <script type="text/javascript" src="/scene/earth.js"></script>
    <script type="text/javascript" src="/scene/physicsFloor.js"></script>
    <script type="text/javascript" src="/scene/astronaut.js"></script>
    <script id="spotlight" type="text/javascript" src="/scene/spotlight.js"></script>

    <!-- LEAVE HERE, THIS MUST COME AFTER GAME LOGIC APPENDED (WHICH IS APPENDED TO SPOTLIGHT LINE 48, TRIED TO MODULARIZE AND THREW ERROR: NO USER YET -->
   <script>
      $(function(){
        //CODE FOR TAKING PICTURE - INCLUDING
        var canvas = document.getElementById('test');
        var canvas2 = document.getElementById('testcanvas');

        var context1 = canvas.getContext('2d');
        var photo = document.getElementById('whiteCircle')

        var context2 = canvas2.getContext('2d');
        var video = document.getElementById('myVideo');

        $('.loading-container').click(function(){
          console.log('clicked ready!');
          user.trackFlag = true;
          $('#throwBall').hide(500);

          var image = context1.drawImage(photo, 0, 0, 160, 120);
          var imageData = context1.getImageData(0, 0, canvas.width, canvas.height);
          console.log(imageData);
          var vid = context2.drawImage(video, 0, 0, 160, 120);
          var videoData = context2.getImageData(0, 0, canvas.width, canvas.height);

            var i;
            let arrRed = [];
            let arrGreen = [];
            let arrBlue = [];
            pixelsNeededIndex = [];

            for (i = 0; i < imageData.data.length; i += 4) {
              if (imageData.data[i] > 235) {


                 imageData.data[i] = videoData.data[i]
                 if (imageData.data[i] > 25) {
                   arrRed.push(imageData.data[i]);
                   pixelsNeededIndex.push(i);
                 }

                 imageData.data[i + 1] = videoData.data[i + 1];
                 if (imageData.data[i + 1] > 25) arrGreen.push(imageData.data[i + 1]);

                 imageData.data[i + 2] = videoData.data[i + 2];
                 if (imageData.data[i + 2] > 25) arrBlue.push(imageData.data[i + 2]);
              }

            }

            function sort(arr) {
              let maxLow = {};

              let average = Math.floor(arr.reduce(function(acc, i) {
                return acc + i;
              }, 0) / arr.length);

              maxLow.lowest = average - 5;
              maxLow.max = average + 5;
              return maxLow;
            }

            minMaxColors = {};

            let reds = sort(arrRed);
            let greens = sort(arrGreen);
            let blues = sort(arrBlue);
            minMaxColors.lowRed = reds.lowest;
            minMaxColors.maxRed = reds.max;
            minMaxColors.lowGreen = greens.lowest;
            minMaxColors.maxGreen = greens.max;
            minMaxColors.lowBlue = blues.lowest;
            minMaxColors.maxBlue = blues.max;

            //console.log('testing', minMaxColors);

            console.log("reds", arrRed);
            console.log("greens", arrGreen);
            console.log("Blue", arrBlue);
            context1.putImageData(imageData, 0, 0);
          demo.checkPicture(imageData);
          //setTimeout(function(){$('#test').remove();}, 1500);
          setTimeout(function(){
            console.log('starting Tracking!');
            demo.tick();
          }, 2000);
        });
      });

    </script>
    <script>
      $(document).ready(function() {

        $('#start-scan').click(function() {
          $('#myVideo').css('width', '160px');
          $('#myVideo').css('height', '120px');

          $('#take-snapshot').css('display', 'block');
        });
      });
    </script>

  </body>

</html>
